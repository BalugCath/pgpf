kind: pipeline
name: default

workspace:
  base: /go
  path: src/github.com/balugcath/pgpf

steps:
- name: build
  image: golang:alpine
  environment:
    CGO_ENABLED: 0
    GO111MODULE: off
  commands:
    - apk add --no-cache git curl
    - go get -v -t -d ./...
    - go build ./cmd/pgpf/...
    - go test -short -coverprofile coverage.txt ./...

- name: coverage
  image: plugins/codecov
  settings:
    token:
      from_secret: codecov_token
    files:
    - coverage.txt

- name: publish latest docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    tag: latest
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    event:
    - push
    - tag

- name: publish release docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    auto_tag: true
    auto_tag_suffix: linux-amd64
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    event:
    - tag

- name: publish binary release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files:
      - pgpf
    checksum:
      - md5
      - sha512
  when:
    event:
    - tag
