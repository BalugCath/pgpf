kind: pipeline
name: default

steps:
- name: build
  image: golang:alpine
  environment:
    CGO_ENABLED: 0
    GO111MODULE: on
    ETCDCTL_API: 3
    PGDATA: /pgdata
  commands:
    - apk add --no-cache git curl postgresql
    - apk add etcd etcd-ctl --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing/
    - mkdir /pgdata /run/postgresql; chown postgres /pgdata /run/postgresql
    - su -c 'pg_ctl init; pg_ctl start' postgres
    - etcd &
    - etcdctl --endpoints http://127.0.0.1:2379 put pgpf < configs/pgpf.yml
    - go build ./cmd/pgpf/...
    - go test -tags integration_test -short -coverprofile coverage.txt ./...

- name: coverage
  image: plugins/codecov
  settings:
    token:
      from_secret: codecov_token
    files:
    - coverage.txt

- name: publish latest docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    tag: latest
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    event:
    - push
    - tag

- name: publish release docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    auto_tag: true
    auto_tag_suffix: linux-amd64
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    event:
    - tag

- name: publish binary release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files:
      - pgpf
    checksum:
      - md5
      - sha512
  when:
    event:
    - tag
