kind: pipeline
name: default

steps:
- name: build
  image: golang:alpine
  environment:
    CGO_ENABLED: 0
    GO111MODULE: on
    ETCDCTL_API: 3
    PGDATA: /pgdata
  network_mode: host
  commands:
    - ls -la
    - pwd
    - apk add --no-cache git curl
    - go build ./cmd/pgpf/...
    - go test -tags integration_test -short -coverprofile coverage.txt ./...

- name: coverage
  image: plugins/codecov
  settings:
    token:
      from_secret: codecov_token
    files:
    - coverage.txt
  when:
    branch:
    - master

- name: publish latest docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    tag: latest
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    branch:
    - master
    event:
    - push
    - tag

- name: publish release docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    auto_tag: true
    auto_tag_suffix: linux-amd64
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    branch:
    - master
    event:
    - tag

- name: publish binary release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files:
      - pgpf
    checksum:
      - md5
      - sha512
  when:
    branch:
    - master
    event:
    - tag

services:
- name: postgres
  image: postgres:latest
  environment:
    POSTGRES_PASSWORD: 123
  network_mode: host

- name: etcd
  image: appcelerator/etcd:latest
  environment:
    SERVICE_NAME: "etcd"
    MIN_SEEDS_COUNT: 1
    ETCDCTL_API: 3
  network_mode: host

#volumes:
#- name: temp
#  temp: {}
