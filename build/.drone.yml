kind: pipeline
name: default

steps:
- name: build
  image: golang:alpine
  environment:
    CGO_ENABLED: 0
    GO111MODULE: on
    ETCDCTL_API: 3
    PGDATA: /pgdata
  commands:
#    - ls -la
#    - pwd
    - apk add --no-cache git curl
    - apk add etcd-ctl --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing/
#    - etcd &
    - go build ./cmd/pgpf/...
    - etcdctl --endpoints http://etcd_test:2379 put pgpf < configs/pgpf.yml
    - go test -tags integration_test -short -coverprofile coverage.txt ./...

- name: coverage
  image: plugins/codecov
  settings:
    token:
      from_secret: codecov_token
    files:
    - coverage.txt
  when:
    branch:
    - master

- name: publish latest docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    tag: latest
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    branch:
    - master
    event:
    - push
    - tag

- name: publish release docker
  image: plugins/docker
  settings:
    repo: balugcath/pgpf
    auto_tag: true
    auto_tag_suffix: linux-amd64
    username: balugcath
    password:
      from_secret: dockerhub_token
    dockerfile: build/Dockerfile
  when:
    branch:
    - master
    event:
    - tag

- name: publish binary release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files:
      - pgpf
    checksum:
      - md5
      - sha512
  when:
    branch:
    - master
    event:
    - tag

services:
- name: postgres_test
  image: postgres:latest
  environment:
    POSTGRES_PASSWORD: 123

- name: etcd_test
  image: appcelerator/etcd:latest
  environment:
    SERVICE_NAME: "etcd_test"
    MIN_SEEDS_COUNT: 0

#volumes:
#- name: temp
#  temp: {}
